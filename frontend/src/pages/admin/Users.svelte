<script>
    import { onMount } from 'svelte'

    import AdminPageLayout from '../../components/AdminPageLayout.svelte'
    import HollowButton from '../../components/HollowButton.svelte'
    import CreateWarrior from '../../components/user/CreateUser.svelte'
    import Pagination from '../../components/Pagination.svelte'
    import CountryFlag from '../../components/user/CountryFlag.svelte'
    import VerifiedIcon from '../../components/icons/Verified.svelte'
    import DeleteConfirmation from '../../components/DeleteConfirmation.svelte'
    import SolidButton from '../../components/SolidButton.svelte'
    import UserAvatar from '../../components/user/UserAvatar.svelte'
    import ProfileForm from '../../components/user/ProfileForm.svelte'
    import Modal from '../../components/Modal.svelte'
    import { warrior } from '../../stores.js'
    import { _ } from '../../i18n.js'
    import { appRoutes } from '../../config.js'
    import { validateUserIsAdmin } from '../../validationUtils.js'

    export let xfetch
    export let router
    export let notifications
    export let eventTag

    const usersPageLimit = 100

    let totalUsers = 0
    let users = []
    let showCreateUser = false
    let usersPage = 1
    let userDeleteId = null
    let showUserDeletion = false
    let searchEmail = ''
    let showUserEdit = false
    let selectedUserProfile = {}

    const toggleDeleteUser = id => () => {
        showUserDeletion = !showUserDeletion
        userDeleteId = id
    }

    function toggleCreateUser() {
        showCreateUser = !showCreateUser
    }

    const toggleUserEdit = profile => () => {
        showUserEdit = !showUserEdit
        selectedUserProfile = profile
    }

    function createUser(
        warriorName,
        warriorEmail,
        warriorPassword1,
        warriorPassword2,
    ) {
        const body = {
            name: warriorName,
            email: warriorEmail,
            password1: warriorPassword1,
            password2: warriorPassword2,
        }

        xfetch('/api/admin/users', { body })
            .then(function () {
                eventTag('admin_create_warrior', 'engagement', 'success')

                getUsers()
                toggleCreateUser()
            })
            .catch(function () {
                notifications.danger($_('createUserError'))
                eventTag('admin_create_warrior', 'engagement', 'failure')
            })
    }

    function getUsers() {
        const offset = (usersPage - 1) * usersPageLimit
        const isSearch = searchEmail !== ''
        const apiPrefix = isSearch
            ? `/api/admin/search/users/email?search=${searchEmail}&`
            : '/api/admin/users?'

        if (isSearch && searchEmail.length < 3) {
            notifications.danger($_('searchLengthError'))
            return
        }

        xfetch(`${apiPrefix}limit=${usersPageLimit}&offset=${offset}`)
            .then(res => res.json())
            .then(function (result) {
                users = result.data
                totalUsers = result.meta.count
            })
            .catch(function () {
                notifications.danger($_('getUsersError'))
            })
    }

    function handleUserEdit(p) {
        xfetch(`/api/users/${selectedUserProfile.id}`, {
            body: p,
            method: 'PUT',
        })
            .then(res => res.json())
            .then(function () {
                notifications.success($_('pages.warriorProfile.updateSuccess'))
                eventTag('update_profile', 'engagement', 'success')
                getUsers()
                toggleUserEdit({})()
            })
            .catch(function () {
                notifications.danger($_('pages.warriorProfile.errorUpdating'))
                eventTag('update_profile', 'engagement', 'failure')
            })
    }

    function promoteUser(userId) {
        return function () {
            xfetch(`/api/admin/users/${userId}/promote`, { method: 'PATCH' })
                .then(function () {
                    eventTag('admin_promote_warrior', 'engagement', 'success')

                    getUsers()
                })
                .catch(function () {
                    notifications.danger($_('promoteUserError'))
                    eventTag('admin_promote_warrior', 'engagement', 'failure')
                })
        }
    }

    function demoteUser(userId) {
        return function () {
            xfetch(`/api/admin/users/${userId}/demote`, { method: 'PATCH' })
                .then(function () {
                    eventTag('admin_demote_warrior', 'engagement', 'success')

                    getUsers()
                })
                .catch(function () {
                    notifications.danger($_('demoteUserError'))
                    eventTag('admin_demote_warrior', 'engagement', 'failure')
                })
        }
    }

    function handleDeleteUser() {
        xfetch(`/api/users/${userDeleteId}`, { method: 'DELETE' })
            .then(function () {
                eventTag('admin_delete_warrior', 'engagement', 'success')

                getUsers()
                toggleDeleteUser(null)()
            })
            .catch(function () {
                notifications.danger('deleteUserError')
                eventTag('admin_delete_warrior', 'engagement', 'failure')
            })
    }

    function onSearchSubmit(evt) {
        evt.preventDefault()

        usersPage = 1
        getUsers()
    }

    const changePage = evt => {
        usersPage = evt.detail
        getUsers()
    }

    onMount(() => {
        if (!$warrior.id) {
            router.route(appRoutes.login)
            return
        }
        if (!validateUserIsAdmin($warrior)) {
            router.route(appRoutes.landing)
            return
        }

        getUsers()
    })
</script>

<svelte:head>
    <title>{$_('users')} {$_('pages.admin.title')} | {$_('appName')}</title>
</svelte:head>

<AdminPageLayout activePage="users">
    <div class="text-center px-2 mb-4">
        <h1
            class="text-3xl md:text-4xl font-semibold font-rajdhani uppercase dark:text-white"
        >
            {$_('users')}
        </h1>
    </div>

    <div class="w-full">
        <div class="flex w-full">
            <div class="w-2/5">
                <h2 class="text-2xl md:text-3xl font-bold mb-4 dark:text-white">
                    {$_('pages.admin.registeredWarriors.title')}
                </h2>
            </div>
            <div class="w-3/5">
                <div class="text-right flex w-full">
                    <div class="w-3/4">
                        <form on:submit="{onSearchSubmit}" name="searchUsers">
                            <div class="mb-4">
                                <label class="mb-2" for="searchEmail">
                                    <input
                                        bind:value="{searchEmail}"
                                        placeholder="{$_('email')}"
                                        class="bg-gray-100 dark:bg-gray-800 appearance-none
                    rounded py-2 px-3 text-gray-700 dark:text-gray-400 leading-tight
                    focus:outline-none focus:bg-white dark:focus:bg-gray-700 focus:border-indigo-500 focus:caret-indigo-500 dark:focus:border-yellow-400 dark:focus:caret-yellow-400"
                                        id="searchEmail"
                                        name="searchEmail"
                                    />
                                </label>
                                <SolidButton type="submit">
                                    {$_('search')}
                                </SolidButton>
                            </div>
                        </form>
                    </div>
                    <div class="w-1/4">
                        <HollowButton onClick="{toggleCreateUser}">
                            {$_('warriorCreate')}
                        </HollowButton>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col">
            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                <div
                    class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8"
                >
                    <div
                        class="shadow overflow-hidden border-b border-gray-200 dark:border-gray-700 sm:rounded-lg"
                    >
                        <table
                            class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
                        >
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th
                                        scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                                    >
                                        {$_(
                                            'pages.admin.registeredWarriors.name',
                                        )}
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                                    >
                                        {$_(
                                            'pages.admin.registeredWarriors.email',
                                        )}
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                                    >
                                        {$_(
                                            'pages.admin.registeredWarriors.company',
                                        )}
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-6 py-3 text-left text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
                                    >
                                        {$_(
                                            'pages.admin.registeredWarriors.rank',
                                        )}
                                    </th>
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-800 dark:text-white"
                            >
                                {#each users as user, i}
                                    <tr
                                        class:bg-slate-100="{i % 2 !== 0}"
                                        class:dark:bg-gray-800="{i % 2 !== 0}"
                                    >
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div
                                                    class="flex-shrink-0 h-10 w-10"
                                                >
                                                    <UserAvatar
                                                        warriorId="{user.id}"
                                                        avatar="{user.avatar}"
                                                        gravatarHash="{user.gravatarHash}"
                                                        width="48"
                                                        class="h-10 w-10 rounded-full"
                                                    />
                                                </div>
                                                <div class="ml-4">
                                                    <div
                                                        class="text-sm font-medium text-gray-900"
                                                    >
                                                        <a
                                                            href="{appRoutes.admin}/users/{user.id}"
                                                            class="text-blue-500 hover:text-blue-800 dark:text-sky-400 dark:hover:text-sky-600"
                                                            >{user.name}</a
                                                        >
                                                        {#if user.country}
                                                            &nbsp;
                                                            <CountryFlag
                                                                country="{user.country}"
                                                                additionalClass="inline-block"
                                                                width="32"
                                                                height="24"
                                                            />
                                                        {/if}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {user.email}
                                            {#if user.verified}
                                                &nbsp;
                                                <span
                                                    class="text-green-600"
                                                    title="{$_(
                                                        'pages.admin.registeredWarriors.verified',
                                                    )}"
                                                >
                                                    <VerifiedIcon />
                                                </span>
                                            {/if}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div
                                                class="text-sm text-gray-900 dark:text-gray-400"
                                            >
                                                {user.company}
                                            </div>
                                            <div
                                                class="text-sm text-gray-500 dark:text-gray-300"
                                            >
                                                {user.jobTitle}
                                            </div>
                                        </td>
                                        <td
                                            class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300"
                                        >
                                            {user.rank}
                                        </td>
                                        <td
                                            class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"
                                        >
                                            {#if user.rank !== 'ADMIN'}
                                                <HollowButton
                                                    onClick="{promoteUser(
                                                        user.id,
                                                    )}"
                                                    color="blue"
                                                >
                                                    {$_('promote')}
                                                </HollowButton>
                                            {:else}
                                                <HollowButton
                                                    onClick="{demoteUser(
                                                        user.id,
                                                    )}"
                                                    color="blue"
                                                >
                                                    {$_('demote')}
                                                </HollowButton>
                                            {/if}
                                            <HollowButton
                                                color="green"
                                                onClick="{toggleUserEdit(user)}"
                                            >
                                                {$_('edit')}
                                            </HollowButton>
                                            <HollowButton
                                                color="red"
                                                onClick="{toggleDeleteUser(
                                                    user.id,
                                                )}"
                                            >
                                                {$_('delete')}
                                            </HollowButton>
                                        </td>
                                    </tr>
                                {/each}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {#if totalUsers > usersPageLimit}
            <div class="pt-6 flex justify-center">
                <Pagination
                    bind:current="{usersPage}"
                    num_items="{totalUsers}"
                    per_page="{usersPageLimit}"
                    on:navigate="{changePage}"
                />
            </div>
        {/if}
    </div>

    {#if showCreateUser}
        <CreateWarrior
            toggleCreate="{toggleCreateUser}"
            handleCreate="{createUser}"
            notifications
        />
    {/if}

    {#if showUserEdit}
        <Modal closeModal="{toggleUserEdit({})}">
            <ProfileForm
                profile="{selectedUserProfile}"
                handleUpdate="{handleUserEdit}"
                xfetch="{xfetch}"
                notifications="{notifications}"
                eventTag="{eventTag}"
            />
        </Modal>
    {/if}

    {#if showUserDeletion}
        <DeleteConfirmation
            toggleDelete="{toggleDeleteUser(null)}"
            handleDelete="{handleDeleteUser}"
            confirmText="{$_('pages.warriorProfile.delete.warningStatement')}"
            confirmBtnText="{$_('pages.warriorProfile.delete.confirmButton')}"
        />
    {/if}
</AdminPageLayout>
